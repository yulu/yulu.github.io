<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Having Fun: Image Processing with OpenGL ES Fragment Shaders</title>
    <meta name="description" content="I am migrating from a blog service provider to github, still trying out with Jekyll
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://yulu.github.io/blog1/2013/01/31/image-processing.html">
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link href="/css/nav.css" type="text/css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

    <!-- Go to www.addthis.com/dashboard to customize your tools -->
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-551ec72a4d0e58c1" async="async"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PB2VMZMH');</script>
    <!-- End Google Tag Manager -->
    <!--latex-->
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <meta name="google-site-verification" content="x60nHOyc_rEQN3p4MCF7G6h-7Yvng4iMYB06RrSZNS4" />
</head>

    
    <body>

    <header>
    <div class="site-header">
        <a href="/"><span>Little<b>CheeseCake.</b></span></a>
    </div>
    <!--nav button-->
<div class="button-background">
    <div class="button-toggle" id="toggle">

        <span class="top"></span>
        <span class="middle_1"></span>
        <span class="middle_2"></span>
        <span class="bottom"></span>
    </div>
</div>
<!--menu overlay-->
<div class="overlay" id="overlay">
    <nav>
        <ul>
            <li><a href="/index.html">Home</a></li>
            <li><a href="/blog2/index.html">Journal</a></li>
            <li><a href="/blog1/index.html">Tech Blog</a></li>
            <li><a href="/books/index.html">Books</li>
            <li><a href="https://www.youtube.com/user/YuLu8798" target="_blank">Vlog</a></li>
            <li><a href="/about/about.html">About</a></li>
        </ul>
    </nav>
</div>
<!--jquery script-->
<script>
    $('.button-background').click(function() {
        $('#toggle').toggleClass('active');
        $('#overlay').toggleClass('open');
    });
</script>

</header>


    <div class="post-image-container">
        
        <img class="post-image" src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/tide.jpg"/>
              
        
        
        
          
    </div>

    <div class="post-wrapper">
        <!-- header -->

        <div class="wrapper">
            <header class="post-header">
                <h1 class="post-title">Having Fun: Image Processing with OpenGL ES Fragment Shaders</h1>
                <p class="post-meta">Jan 31, 2013</p>
            </header>
        </div>

        <!-- table of content -->
        <div class="post-toc" id="toc">  </div> 

        <article class="post-content">
            <p>I have taken a very long time to get myself familiar with OpenGL ES Shaders. Finally I made some codes run and got some results that looked nice. The main area I want to explore is to use shaders to perform general purpose GPU computation (GPGPU). Here I summarize some image manipulation examples from the very popular textbook Graphics Shaders: theory and practice by Bailey and Cunningham. The examples are made to be running on the Android phone.</p>

<h3 id="texture-mapping-using-opengl-es-20">Texture mapping using OpenGL ES 2.0</h3>

<p><a href="http://www.learnopengles.com/android-lesson-one-getting-started/">Here</a> is a good online tutorial to get start with on OpenGL ES 2.0 for Android. A simple project of texture mapping is created. It basically maps an bitmap image to a square fragment that fits into the window size of the device. The fun things I am going to do start from this stage.</p>

<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/16905771328_c58d995850_z.jpg" alt="rendering" /></p>

<h3 id="basic-concepts">Basic Concepts</h3>

<p>GLSL deals with images by treating them as textures and using texture access and manipulation to set the color of each pixel in the color buffer. This texture file may be treated as an image raster by working with each texel individually. Since any OpenGL texture has texture coordinates ranging from 0.0 to 1.0, the coordinates of the center of the image are vec(0.5, 0.5) and you can increment texture coordinates by 1./ResS or 1./ResT to move from one texel to another horizontally or vertically. ResS and ResT are the sizes of the displayed image in pixel.</p>

<h3 id="working-with-fragment-shaders">Working with Fragment Shaders</h3>

<p>The Fragment Shader is responsible for the per texel processing. The manipulation of the image pixels are handled merely using Fragment Shaders. Here is the simple fragment shader that just displays the texture:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">precision</span> <span class="n">mediump</span> <span class="kt">float</span><span class="p">;</span>
<span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">u_Texture</span><span class="p">;</span>
<span class="n">varying</span> <span class="n">vec2</span> <span class="n">v_TexCoordinate</span><span class="p">;</span> 

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="p">(</span><span class="n">texture2D</span><span class="p">(</span><span class="n">u_Texture</span><span class="p">,</span> <span class="n">v_TexCoordinate</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<h4 id="colorbrightnesshue">Color/Brightness/Hue</h4>

<p><em>Luminance</em>: luminance is defined as a linear combination of red, green and blue. The weight vector is a const: <code class="language-plaintext highlighter-rouge">vec3(0.2125, 0.7154, 0.0721)</code>.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">u_Texture</span><span class="p">;</span>
<span class="n">varying</span> <span class="n">vec2</span> <span class="n">v_TexCoordinate</span><span class="p">;</span> 
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span> 
    <span class="k">const</span> <span class="n">vec3</span> <span class="n">W</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2125</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1754</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mo">0721</span><span class="p">);</span> 
    <span class="n">vec3</span> <span class="n">irgb</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">u_Texture</span><span class="p">,</span> <span class="n">v_TexCoordinate</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span> 
    <span class="kt">float</span> <span class="n">luminance</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">irgb</span><span class="p">,</span> <span class="n">W</span><span class="p">);</span> 
    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="n">luminance</span><span class="p">,</span> <span class="n">luminance</span><span class="p">,</span> <span class="n">luminance</span><span class="p">,</span> <span class="mi">1</span><span class="p">.);</span>
<span class="p">}</span></code></pre></figure>

<figcaption>
Illuminance Adjustment
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/16907296299_82e96ecba3_z.jpg" alt="illuminance" /></p>

<p><em>Hue shifting</em>: the RGB is first converted into the HSV color space, the hue shifting is just a adjustment of the h value in degree.The code is a bit long, check it out in the source code directory.</p>

<figcaption>
Hue Shift
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/17093504515_9523c3c071_z.jpg" alt="hueshift" /></p>

<p><em>Negative</em>: negative is obtained by subtracting the color of each pixel from the white</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">precision</span> <span class="n">mediump</span> <span class="kt">float</span><span class="p">;</span>
<span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">u_Texture</span><span class="p">;</span>
<span class="n">varying</span> <span class="n">vec2</span> <span class="n">v_TexCoordinate</span><span class="p">;</span> 

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span> 
    <span class="n">vec2</span> <span class="n">st</span> <span class="o">=</span> <span class="n">v_TexCoordinate</span><span class="p">.</span><span class="n">st</span><span class="p">;</span>
    <span class="n">vec3</span> <span class="n">irgb</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">u_Texture</span><span class="p">,</span> <span class="n">st</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">vec3</span> <span class="n">neg</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mi">1</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.,</span> <span class="mi">1</span><span class="p">.)</span><span class="o">-</span><span class="n">irgb</span><span class="p">;</span>
    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="n">mix</span><span class="p">(</span><span class="n">irgb</span><span class="p">,</span><span class="n">neg</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="mi">1</span><span class="p">.);</span>
<span class="p">}</span></code></pre></figure>

<figcaption>
Negative
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/17067558526_7787654204_z.jpg" alt="negative" /></p>

<p><em>Brightness</em>: add or subtract black can be used to adjust the brightness of the image</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">precision</span> <span class="n">mediump</span> <span class="kt">float</span><span class="p">;</span>
<span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">u_Texture</span><span class="p">;</span>
<span class="n">varying</span> <span class="n">vec2</span> <span class="n">v_TexCoordinate</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">vec2</span> <span class="n">st</span> <span class="o">=</span> <span class="n">v_TexCoordinate</span><span class="p">.</span><span class="n">st</span><span class="p">;</span>
    <span class="n">vec3</span> <span class="n">irgb</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">u_Texture</span><span class="p">,</span> <span class="n">st</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">vec3</span> <span class="n">black</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">.,</span> <span class="mi">0</span><span class="p">.,</span> <span class="mi">0</span><span class="p">.);</span>
    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="n">mix</span><span class="p">(</span><span class="n">black</span><span class="p">,</span> <span class="n">irgb</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="mi">1</span><span class="p">.);</span>
<span class="p">}</span></code></pre></figure>

<figcaption>
Brightness Adjustment
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/16473298933_3a217ae515_z.jpg" alt="brightness" /></p>

<p><em>Contrast</em>: use a gray image as a base image, and mix with the color image. It can be made either move the color component towards the gray or away from. That is how the contrast is adjusted.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">precision</span> <span class="n">mediump</span> <span class="kt">float</span><span class="p">;</span>
<span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">u_Texture</span><span class="p">;</span>
<span class="n">varying</span> <span class="n">vec2</span> <span class="n">v_TexCoordinate</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">vec2</span> <span class="n">st</span> <span class="o">=</span> <span class="n">v_TexCoordinate</span><span class="p">.</span><span class="n">st</span><span class="p">;</span>
    <span class="n">vec3</span> <span class="n">irgb</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">u_Texture</span><span class="p">,</span> <span class="n">st</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">vec3</span> <span class="n">target</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="n">mix</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">irgb</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="mi">1</span><span class="p">.);</span>
<span class="p">}</span></code></pre></figure>

<p><em>Saturation</em>: mix the color and grayscale image from the luminance example, can obtain a saturated image</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">precision</span> <span class="n">mediump</span> <span class="kt">float</span><span class="p">;</span>
<span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">u_Texture</span><span class="p">;</span>
<span class="n">varying</span> <span class="n">vec2</span> <span class="n">v_TexCoordinate</span><span class="p">;</span> 
<span class="k">const</span> <span class="n">vec3</span> <span class="n">W</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2125</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7154</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mo">0721</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="n">vec2</span> <span class="n">st</span> <span class="o">=</span> <span class="n">v_TexCoordinate</span><span class="p">.</span><span class="n">st</span><span class="p">;</span>
    <span class="n">vec3</span> <span class="n">irgb</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">u_Texture</span><span class="p">,</span> <span class="n">st</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span> 
    <span class="kt">float</span> <span class="n">luminance</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">irgb</span><span class="p">,</span> <span class="n">W</span><span class="p">);</span>
    <span class="n">vec3</span> <span class="n">target</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="n">luminance</span><span class="p">,</span> <span class="n">luminance</span><span class="p">,</span> <span class="n">luminance</span><span class="p">);</span> 
    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="n">mix</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">irgb</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="mi">1</span><span class="p">.);</span>
<span class="p">}</span></code></pre></figure>

<h4 id="warpingdistortion">Warping/Distortion</h4>

<p>The twirl transformation rotates the image around a given anchor point(xc, yc) by an angle that varies across the space from a value alpha at the center, decreasing linearly with the radial distance as it proceeds toward a limiting radius r. There are lots of other transformation worthy being tried.</p>

<figcaption>
Twirl
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/16473395223_2cae1c636e_z.jpg" alt="twirl" /></p>

<h4 id="image-processingvision">Image processing/vision</h4>

<p><em>Edge detection</em>: <a href="http://en.wikipedia.org/wiki/Sobel_operator">Sobel filter</a> is used for edge detection. The manipulation of neighboring pixels are required. Here we need to know the exact width and height of the texture displayed in pixel. However I haven’t figure out how to do this. So I cheated a bit, just use the screen height (720 px in this case) since the image is assumed to fit in the window, which is not exactly true.</p>

<figcaption>
Edge Detection
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/17093470525_f64935b03a_z.jpg" alt="edge" /></p>

<p><em>Blurring</em>: 3x3 Gaussian filter s used for blurring in this case. The result is not a obvious since a small radius is used.</p>

<figcaption>
Blur Effect
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/17091947422_fbb60308e9_z.jpg" alt="blurring" /></p>

<h4 id="artistic-effect">Artistic Effect</h4>

<p><em>Embossing</em>: the embossing image is obtained from applying the edge detection luminanced image and highlighting the images differently depending on the edge’s angle.</p>

<figcaption>
Emboss Effect
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/17093478185_5feab22704_z.jpg" alt="emboss" /></p>

<p><em>Toon like image</em>: steps includes -Calculate the luminance of each pixel, apply the Sobel filter to detect edge and get a magnitude, if magnitude is larger than the threshold, color the pixel black, else quantize the pixel’s color.</p>

<figcaption>
Toon Effect
</figcaption>
<p><img src="https://s3.ap-southeast-1.amazonaws.com/littlecheesecake.me/blog-post/blog1/archive/17093548725_9cf8a4e090_z.jpg" alt="toon" /></p>

<h3 id="closure">Closure</h3>

<p>These are all simple image manipulations that can be easily done by software like Photoshop. The interesting thing is that it is now running on the GPU of the embedded devices. The advances of GPGPU might not be seen from here, but I will try to do some efficiency evaluations and continue with my “serious” research to see how it will help. Source Code on <a href="https://github.com/yulu/GLtext">Github</a></p>



            <div class="post-end">
                <!-- buy me a coffee -->
                <div>
                    <a href="https://www.buymeacoffee.com/8QcoMFJNHD" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px !important;width: 150px !important;" ></a>
                </div>
                <div class="share-container">
                    <!-- Go to www.addthis.com/dashboard to customize your tools -->
                    <span class="share-text">Share the post </span><div class="addthis_sharing_toolbox"></div>
                </div>
                <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//littlecheesecakeme.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </article>
    </div>

    <footer>
     <div class="site-footer page">
         <p>Build with love, <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://github.com/yulu/yulu.github.io">Github Page</a> by <a href="/about/about.html"><em>Yu Lu</em></a></p>
    </div>
    
</footer>
    
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PB2VMZMH"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    </body>

    <!--jquery script for sticky toc-->
    <script>
        window.onscroll = function() {myFunction()};

        // Get the header
        var header = document.getElementById("toc");

        // Get the offset position of the navbar
        var sticky = header.offsetTop;

        // Add the sticky class to the header when you reach its scroll position. Remove "sticky" when you leave the scroll position
        function myFunction() {
            if (window.pageYOffset > sticky) {
                header.classList.add("sticky");
            } else {
                header.classList.remove("sticky");
            }
        }
    </script>
</html>
